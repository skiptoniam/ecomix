<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Region of Common Profiles Example • ecomix</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Region of Common Profiles Example">
<meta property="og:description" content="ecomix">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ecomix</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/RCP-example.html">Region of Common Profiles Example</a>
    </li>
    <li>
      <a href="../articles/SAM-example.html">Species Archetype Model Example</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/skiptoniam/ecomix/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="RCP-example_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Region of Common Profiles Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/skiptoniam/ecomix/blob/master/vignettes/RCP-example.Rmd"><code>vignettes/RCP-example.Rmd</code></a></small>
      <div class="hidden name"><code>RCP-example.Rmd</code></div>

    </div>

    
    
<div id="regions-of-common-profile-models" class="section level3">
<h3 class="hasAnchor">
<a href="#regions-of-common-profile-models" class="anchor"></a>Regions of Common Profile Models</h3>
<p>The Regions of Common Profile (RCP) models are a type of ‘Mixture-of-Experts Models’ and try to describe how homogeneous groups of <strong>sites</strong> vary with the environment. This is done by grouping sites based on the biological content (species observed at each site) and determine how these groups vary across environmental or physical gradients <span class="citation">(Foster <em>et al.</em> 2013)</span>. This approach assumes that assemblages of species at a site exists, and each assemblage can be described by its mean expectation of all species at that site. Within the the RCP model, these indicies are used to represent the data: sites as <span class="math inline">\(i = 1...n\)</span>, species as <span class="math inline">\(j = 1...S\)</span> and groups as <span class="math inline">\(k = 1...K\)</span> (we refer to these as RCPs). The model conditional expectation (given site membership) for all species is, <span class="math inline">\(\mathbb{E}(y_{ij}|z_{ik}=1)\)</span>. The model can be described as:</p>
<p><span class="math display">\[
\begin{equation}
h[\mathbb{E}(y_{ij}|z_{ik})] = \alpha_j + X_i^\top\tau_j \tag{3}\label{eq:three}
\end{equation}
\]</span></p>
<p>Where <span class="math inline">\(\alpha_j\)</span> is a species-specific intercept, <span class="math inline">\(X_j^\top\)</span> is a design matrix of covariates used to describe the RCPs. We can adjust the assemblage profile based on the species-wise expectation by incorporating a species wise covariates which can account for sampling artefacts. This extension was described in <span class="citation">Foster <em>et al.</em> (2017)</span>.</p>
<p><span class="math display">\[
\begin{equation}
h[\mathbb{E}(y_{ij}|z_{ik})] = \alpha_j + X_i^\top\tau_j + W_i^\top\gamma_j + \nu_i \tag{4}\label{eq:four}
\end{equation}
\]</span> Where <span class="math inline">\(W_i\)</span> is a design matrix which represents covariates that could account for sampling biases in the observation of species at sites. Examples covariates to represent <span class="math inline">\(W_i\)</span> might include the methods of collection of each sample or the time of day each sample was taken. These covariates then try and marginalize out observation difference of species at sites based on the input covariates, <span class="math inline">\(\gamma_j\)</span> are species-specific parameters which describes these biases. Similar to the SAMs models any appropriate functional form can be used to describe the species-specific responses to physical environments or sampling artefacts. <span class="math inline">\(\nu_i\)</span> is an offset which can be included to account between difference in sites specific survey effort (e.g. area survey). Any dispersion parameters, such as those for Negative Binomial, Tweedie or Gaussian model will also need to be estimated. <span class="math inline">\(z_i\)</span> is an unobserved variable and is treated as a latent factor. The model assumes that <span class="math inline">\(z_i\)</span> is the result of a multinomial sampling process with one trial and <span class="math inline">\(k x 1\)</span> probability vector <span class="math inline">\(\pi_i\)</span>. The RCP model allows the RCP probability vector <span class="math inline">\(\pi_i\)</span> to vary depending on the observation site’s position in environmental and geographical space. Where <span class="math inline">\(\pi_i=h(X_i)\)</span>, and <span class="math inline">\(X_i\)</span> is the design matrix which contains the environmental and spatial covariates to describe site <span class="math inline">\(i\)</span>. <span class="math inline">\(h(.)\)</span> is represented by a additive logistic function <span class="citation">(Aitchison 1982)</span> whose <span class="math inline">\(k\)</span>th component is represented as:</p>
<p><span class="math display">\[
\begin{equation}
\pi_{ik}\triangleq h(X_i,k)=
\begin{cases}
  \frac{exp(X_i^\top\beta_k)}{1 + \sum_{m=1}^{K-1}\exp{X_i^\top\beta_{k'}}}, &amp; \text{if $1 \leq k \leq K-1$,}\\
  1 + \sum_{m=1}^{K-1}\pi_{ik'}, &amp; \text{if $k = K$,}\tag{5}\label{eq:five}
\end{cases}
\end{equation}
\]</span></p>
<p>In this function <span class="math inline">\(\beta_k\)</span> holds the parameter values for the <span class="math inline">\(k\)</span>th linear combination which represents the environmental or physical covariates used to describe each RCP. The RCP model available for use in the <code>ecomix</code> package are comprised of the following three components. A model for RCP type which is described by the environmental and spatial covariates, a model for the expectation of each species’ observations with reference to the sampling approach or artefacts and a parametric model for how the observations vary around these mean species-specific expectations. RCP to date have largely been used for describing bioregions, ecoregions or assemblages classification for spatial management <span class="citation">(Hill <em>et al.</em> 2017; Lyons <em>et al.</em> 2017)</span>. So this model can viewed as model-based bioregionalisation approach <span class="citation">(Hill <em>et al.</em> 2020; Woolley <em>et al.</em> 2020)</span>. Where the probability of each RCP type occurring at each prediction point (site or prediction surface), represents a probabilistic distribution of an assemblage of species. These probabilities for each RCP can be directly assessed via equation 4.</p>
<div id="simulate-environmental-data" class="section level4">
<h4 class="hasAnchor">
<a href="#simulate-environmental-data" class="anchor"></a>Simulate Environmental Data</h4>
<p>We generate a set of simulated environment predictors using Gaussian random fields with nugget effects on some of the variables.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ms.math.uni-mannheim.de/de/publications/software/randomfields">RandomFields</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">007</span><span class="op">)</span>
<span class="va">lenny</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">xSeq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span> from<span class="op">=</span><span class="fl">0</span>, to<span class="op">=</span><span class="fl">1</span>, length<span class="op">=</span><span class="va">lenny</span><span class="op">)</span>
<span class="va">ySeq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span> from<span class="op">=</span><span class="fl">0</span>, to<span class="op">=</span><span class="fl">1</span>, length<span class="op">=</span><span class="va">lenny</span><span class="op">)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">xSeq</span>, y<span class="op">=</span><span class="va">ySeq</span><span class="op">)</span>
<span class="va">Mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMgauss.html">RMgauss</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">1</span>, scale<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMnugget.html">RMnugget</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span>
<span class="va">Mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMgauss.html">RMgauss</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">1</span>, scale<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMnugget.html">RMnugget</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span>
<span class="va">Mod3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMgauss.html">RMgauss</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">1</span>, scale<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="co"># + RMnugget( var=0.01)</span>
<span class="va">Mod4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMgauss.html">RMgauss</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">2</span>, scale<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RMnugget.html">RMnugget</a></span><span class="op">(</span> var<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="va">simmy1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RFsimulate.html">RFsimulate</a></span><span class="op">(</span> <span class="va">Mod1</span>, x<span class="op">=</span><span class="va">xSeq</span>, y<span class="op">=</span><span class="va">ySeq</span><span class="op">)</span>
<span class="va">simmy2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RFsimulate.html">RFsimulate</a></span><span class="op">(</span> <span class="va">Mod2</span>, x<span class="op">=</span><span class="va">xSeq</span>, y<span class="op">=</span><span class="va">ySeq</span><span class="op">)</span>
<span class="va">simmy3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RFsimulate.html">RFsimulate</a></span><span class="op">(</span> <span class="va">Mod3</span>, x<span class="op">=</span><span class="va">xSeq</span>, y<span class="op">=</span><span class="va">ySeq</span><span class="op">)</span>
<span class="va">simmy4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/RFsimulate.html">RFsimulate</a></span><span class="op">(</span> <span class="va">Mod4</span>, x<span class="op">=</span><span class="va">xSeq</span>, y<span class="op">=</span><span class="va">ySeq</span><span class="op">)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span> <span class="va">X</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">simmy1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">simmy2</span><span class="op">)</span><span class="op">)</span>,
            <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">simmy3</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">simmy4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span> <span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span> <span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/QMath.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span>,<span class="st">"covar1"</span>,<span class="st">"covar2"</span>,<span class="st">"covar3"</span>,<span class="st">"covar4"</span><span class="op">)</span>
<span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterFromXYZ.html">rasterFromXYZ</a></span><span class="op">(</span> <span class="va">X</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RandomFields/man/QMath.html">c</a></span><span class="op">(</span><span class="st">"Temperature"</span>, <span class="st">"Oxygen"</span>, <span class="st">"Depth"</span>, <span class="st">"Productivity"</span><span class="op">)</span>
<span class="va">env.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">env</span>,xy<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">env_dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPoints.html">rasterToPoints</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="RCP-example_files/figure-html/env%20plots-1.png" alt="Figure 1. Simulated environmental variables used in Species Archetype Modelling" width="384"><p class="caption">
Figure 1. Simulated environmental variables used in Species Archetype Modelling
</p>
</div>
</div>
<div id="model-fitting" class="section level4">
<h4 class="hasAnchor">
<a href="#model-fitting" class="anchor"></a>Model fitting</h4>
<p>Due to the complex nature of the likelihood surface we need to use a multiple fitting approach to converge on the best model. This is computationally expensive for a big models, but it ensures that a detailed exploration of the model log-likelihood to help find the global maximum. We can use the <code>regional_mix.multifit</code> function to do this, this will return a list of models with <code>nstarts</code> as the number of starts to trying when searching the log-likelihood. Once we have run the multiple fits we select the ‘best’ models based on Bayesian Information Criteria (BIC), being aware that the ‘best’ model in both SAMs and RCPs can change dependent on the number of groups chosen and the functional for the covariates in the model. This is typically why we fit a full model with all the covariates and their expected functional form fixed and then we iterate thought <span class="math inline">\(k\)</span> the number of groups. Once <span class="math inline">\(k\)</span> is selected we could do model selection on the covariates with a fixed number of groups if so desired. Here we present a plot of the BIC values from a 100 fits per each of the model first for one to six RCPs (fig. 4a). We can that for these data and this covariate structure three RCPs appears to be the most parsimonious fit.</p>
<!-- ```{r,eval=TRUE,message=FALSE, warning= FALSE} -->
<!-- RCP_form <- as.formula(paste("cbind(",paste(species, collapse=", "),")~", -->
<!--                         paste(paste0("poly(",rcp_env_vars,",degree=2)"), collapse="+"))) -->
<!-- species_form <- ~ Season -->
<!-- # species_form -->
<!-- nstarts<-10 -->
<!-- max.nRCP<-6 -->
<!-- nRCPs_samp <- list() -->
<!-- for( ii in 1:max.nRCP)  -->
<!--   nRCPs_samp[[ii]] <- regional_mix.multifit(rcp_formula = RCP_form, -->
<!--                                             species_formula =  ~ Season, -->
<!--                                             data = fish, nRCP=ii, -->
<!--                                             inits="random2", -->
<!--                                             nstart=nstarts, -->
<!--                                             family = "negative.binomial", -->
<!--                                             mc.cores=3, -->
<!--                                             control=list(quiet=TRUE)) -->
<!-- ``` -->
<!-- ```{r rcp bic chunk} -->
<!-- max.nRCP<-6 -->
<!-- RCPsamp_BICs <- sapply( nRCPs_samp, function(x) sapply( x, function(y) y$BIC)) -->
<!-- RCPsamp_minPosteriorSites <- cbind( 181, sapply( nRCPs_samp[-1], function(y) sapply( y, function(x) min( colSums( x$postProbs))))) -->
<!-- RCPsamp_ObviouslyBad <- RCPsamp_minPosteriorSites < 2 -->
<!-- RCPsamp_BICs[RCPsamp_ObviouslyBad] <- NA -->
<!-- RCPsamp_minBICs <- apply( RCPsamp_BICs, 2, min, na.rm=TRUE) -->
<!-- grps=1:max.nRCP -->
<!-- df2a <- data.frame(grps=grps,bic=RCPsamp_minBICs) -->
<!-- df2b <- data.frame(grps=rep(grps, each=nrow( RCPsamp_BICs)),bic=as.numeric(RCPsamp_BICs)) -->
<!-- p4a <- ggplot(df2a,aes(x=grps,y=bic))+ -->
<!--       geom_point()+ -->
<!--       geom_line()+ -->
<!--       geom_point(data=df2b,aes(x=grps,y=bic))+ -->
<!--       scale_x_continuous("Number of Groups", labels = as.character(grps), breaks = grps)+ -->
<!--       ylab("BIC")+ -->
<!--       ggtitle("a)") -->
<!-- RCPsamp_goodun <- which.min( RCPsamp_BICs[,3]) -->
<!-- control <- list( optimise=FALSE, quiet=FALSE) -->
<!-- RCPsamp_fin<-regional_mix(rcp_formula = RCP_form, species_formula = species_form,  -->
<!--                      nRCP=3, data=fish, family = "negative.binomial", -->
<!--                      inits = unlist( nRCPs_samp[[3]][[RCPsamp_goodun]]$coef), control=control) -->
<!-- rm(RCPsamp_BICs,RCPsamp_minPosteriorSites, RCPsamp_ObviouslyBad, RCPsamp_minBICs, RCPsamp_goodun, control) -->
<!-- ``` -->
<!-- ```{r rcp residuals, echo=FALSE, fig.height=6, fig.width=8} -->
<!-- resids <- residuals(RCPsamp_fin) -->
<!-- # dim(resids) -->
<!-- colnames(resids) <- species -->
<!-- sppID <- rep( TRUE, RCPsamp_fin$S) -->
<!-- preds <- matrix( NA, nrow=RCPsamp_fin$n, ncol=RCPsamp_fin$S) -->
<!-- for( ii in 1:RCPsamp_fin$n){ -->
<!--       preds[ii,] <- rowSums( RCPsamp_fin$mu[ii,sppID,] * matrix( rep( RCPsamp_fin$pi[ii,], each=RCPsamp_fin$S), nrow=RCPsamp_fin$S, ncol=RCPsamp_fin$nRCP)) -->
<!-- } -->
<!-- df <- data.frame(idx = 1:nrow(resids),resids) -->
<!-- dfm <- reshape2::melt(df,id.var='idx') -->
<!-- dfm$preds <- c(log(preds)) -->
<!-- colnames(dfm) <- c("idx","Species","RQR","preds") -->
<!-- getPalette = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1")) -->
<!-- colourCount = length(unique(dfm$Species)) -->
<!-- p4b <- ggplot(dfm,aes(x=preds,y=RQR,colour=Species))+ -->
<!--       geom_point()+ -->
<!--       scale_color_manual(values = getPalette(colourCount))+ -->
<!--       xlab("Fitted values (log scale)")+ -->
<!--       ylab("RQR")+ -->
<!--       ggtitle("b)")+ -->
<!--       theme(legend.position = "none") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- library(ggplot2) -->
<!-- library(reshape2) -->
<!-- library(dplyr) -->
<!-- library(tidyr) -->
<!-- library(forcats) -->
<!-- rcpsamp_boots<-regional_mix.bootstrap(RCPsamp_fin, type="BayesBoot", nboot=10, mc.cores=1,quiet = TRUE) -->
<!-- RCP_abund_samp <- regional_mix.species_profile(RCPsamp_fin,rcpsamp_boots,type='link') -->
<!-- df1 <- rbind(cbind(CI="lwr",melt(RCP_abund_samp$overall$lower)), -->
<!--       cbind(CI="mean",melt(RCP_abund_samp$overall$mean)), -->
<!--       cbind(CI="upper",melt(RCP_abund_samp$overall$upper))) -->
<!-- colnames(df1)<- c("CI","RCP","Species","Value") -->
<!-- df1$Species <- gsub("[.]"," ",df1$Species) -->
<!-- df <- reshape(df1,idvar=c("Species","RCP"),timevar = "CI",direction = "wide") -->
<!-- rcp_name1 <- c( -->
<!--   RCP1 = "RCP 1", -->
<!--   RCP2 = "RCP 2", -->
<!--   RCP3 = "RCP 3") -->
<!-- p4c <- ggplot(data =  df) + -->
<!--        geom_point(aes(x = Value.mean, y = fct_reorder(Species,desc(Species))))+  -->
<!--        geom_linerange(aes(xmin= Value.lwr,xmax=Value.upper, y= fct_reorder(Species,desc(Species))))+ -->
<!--   facet_wrap(~ RCP, labeller = labeller(RCP = rcp_name1))+ -->
<!--   ggtitle('c)')+ -->
<!--   geom_vline(xintercept = 0, col="gray20",lty=2)+ -->
<!--   # coord_fixed()+ -->
<!--   theme_bw()+ -->
<!--   theme(panel.grid = element_blank()) + -->
<!--   xlab("log(Abundance)")+ -->
<!--   ylab("Species") -->
<!-- ## generate figure of species profiles -->
<!-- pred_space_rcp$Season <- factor("Autumn/Winter",levels=unique(fish$Season)) -->
<!-- RCPsamp_SpPreds <- predict(object=RCPsamp_fin, object2=rcpsamp_boots, newdata=pred_space_rcp) -->
<!-- pred.df <- data.frame(x=pred_space_rcp$x,y=pred_space_rcp$y, -->
<!--                       lwr=RCPsamp_SpPreds$bootCIs[,,1], -->
<!--                       mean=RCPsamp_SpPreds$bootPred, -->
<!--                       upper=RCPsamp_SpPreds$bootCIs[,,2]) -->
<!-- pred.dfm <- melt(pred.df,id.vars = c("x","y")) -->
<!-- pred.dfm$RCP <- gsub(".*[.]","",pred.dfm$variable) -->
<!-- pred.dfm$CI <- gsub("[.].*","",pred.dfm$variable) -->
<!-- df <- data.frame(pred.dfm) -->
<!-- rcp_name <- c( -->
<!--   RCP_1 = "RCP 1", -->
<!--   RCP_2 = "RCP 2", -->
<!--   RCP_3 = "RCP 3") -->
<!-- ci_name <- c( -->
<!--   lwr = "Lower CI", -->
<!--   mean = "Point Prediction", -->
<!--   upper = "Upper CI") -->
<!-- colour <- c("#dddddd","#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d")#,"#000000") -->
<!-- breaks <- c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1) -->
<!-- p4d <- ggplot() + -->
<!--   geom_raster(data =  df, aes(x = x, y = y, fill=value)) +  -->
<!--   scale_fill_gradientn(colours = colour, na.value = 'transparent')+ -->
<!--   labs(fill="Probability")+ -->
<!--   facet_grid(RCP ~ CI, labeller = labeller(RCP = rcp_name, CI=ci_name), switch = "y")+ -->
<!--   scale_x_continuous(expand=c(0, 0)) +  -->
<!--   scale_y_continuous(expand=c(0, 0))+ -->
<!--   ggtitle('d)')+ -->
<!--   # coord_fixed()+ -->
<!--   theme_bw()+ -->
<!--   theme(axis.title.x = element_blank(),  -->
<!--         axis.title.y = element_blank(), -->
<!--         # axis.text.x = element_text(angle = 30), -->
<!--         panel.grid = element_blank(), -->
<!--         legend.position="bottom", -->
<!--         legend.box="horizontal") + -->
<!--   xlab("Longitude")+ -->
<!--   ylab("Latitude") -->
<!-- ``` -->
<!-- ```{r RCP plots, fig.width= 10, fig.height= 8, fig.cap="Figure 4. a) BIC value from the RCP multiple fits, three RCPs appears to be the best fit to these data; b) BIC values from multiple fits for  Predicted Regions of Common Profile distributios and associated uncertainty in predictions", echo=FALSE} -->
<!-- library(gridExtra) -->
<!-- lay <- rbind(c(1,3,3), -->
<!--              c(2,3,3), -->
<!--              c(4,4,4), -->
<!--              c(4,4,4), -->
<!--              c(4,4,4)) -->
<!-- grid.arrange(p4a, p4b, p4c, p4d, layout_matrix= lay) -->
<!-- ``` -->
<div id="refs" class="references">
<div id="ref-aitchison_statistical_1982">
<p>Aitchison, J. (1982). The statistical analysis of compositional data. <em>Journal of the Royal Statistical Society. Series B (Methodological)</em>, 139–177.</p>
</div>
<div id="ref-foster_modelling_2013">
<p>Foster, S., Givens, G., Dornan, G., Dunstan, P. &amp; Darnell, R. (2013). Modelling biological regions from multi-species and environmental data. <em>Environmetrics</em>, <strong>24</strong>, 489–499.</p>
</div>
<div id="ref-foster_ecological_2017">
<p>Foster, S.D., Hill, N.A. &amp; Lyons, M. (2017). Ecological grouping of survey sites when sampling artefacts are present. <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em>, <strong>66</strong>, 1031–1047.</p>
</div>
<div id="ref-hill_model-based_2017">
<p>Hill, N.A., Foster, S.D., Duhamel, G., Welsford, D., Koubbi, P. &amp; Johnson, C.R. (2017). Model-based mapping of assemblages for ecology and conservation management: A case study of demersal fish on the Kerguelen Plateau. <em>Diversity and Distributions</em>, <strong>23</strong>, 1216–1230.</p>
</div>
<div id="ref-hill_determining_2020">
<p>Hill, N., Woolley, S.N., Foster, S., Dunstan, P.K., McKinlay, J., Ovaskainen, O. &amp; Johnson, C. (2020). Determining marine bioregions: A comparison of quantitative approaches. <em>Methods in Ecology and Evolution</em>, <strong>11</strong>, 1258–1272.</p>
</div>
<div id="ref-lyons_simultaneous_2017">
<p>Lyons, M.B., Foster, S.D. &amp; Keith, D.A. (2017). Simultaneous vegetation classification and mapping at large spatial scales. <em>Journal of biogeography</em>, <strong>44</strong>, 2891–2902.</p>
</div>
<div id="ref-woolley_bioregions_2020">
<p>Woolley, S.N., Foster, S.D., Bax, N.J., Currie, J.C., Dunn, D.C., Hansen, C., Hill, N., O’Hara, T.D., Ovaskainen, O., Sayre, R. &amp; others. (2020). Bioregions in Marine Environments: Combining Biological and Environmental Data for Management and Scientific Understanding. <em>BioScience</em>, <strong>70</strong>, 48–59.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Skipton Woolley, Scott Foster, Piers Dunstan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
